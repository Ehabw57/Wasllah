<!doctype html>
<html>
  <head>
    <title>wassla</title>
  </head>
  <body>
    <h1>connected Devices:</h1>
    <div id="devices"></div>
    <script>
      const socket = new WebSocket("ws://localhost:3000");
      const devicesDiv = document.getElementById("devices");
      const pc = new RTCPeerConnection();
      let dataChannel = null;
      pc.onconnectionstatechange = () => {
        console.log("Connection state:", pc.connectionState);
      };

      // Handle incoming data channels (answers side)
      pc.ondatachannel = (event) => {
        dataChannel = event.channel;
        dataChannel.onopen = () => console.log('Data channel opened');
        dataChannel.onmessage = (ev) => console.log('Data channel message:', ev.data);
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.send(
            JSON.stringify({
              type: "ice-candidate",
              candidate: event.candidate,
              targetId: pc.peerId,
            }),
          );
        }
      };

      function sendData(data) {
        console.log("Sending data:", data);
        if (dataChannel && dataChannel.readyState === 'open') {
          dataChannel.send(data);
        } else {
          console.log('Data channel is not open');
        }
      }

      async function sendOffer(targetId) {
        pc.peerId = targetId;

        dataChannel = pc.createDataChannel('data');
        dataChannel.onopen = () => console.log('Data channel open');
        dataChannel.onmessage = (e) => console.log('Data channel message:', e.data);

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.send(
          JSON.stringify({
            type: 'offer',
            offer: pc.localDescription,
            targetId,
          }),
        );
      }

      socket.onopen = () => {
        console.log("Connected to server");
        const name = navigator.platform;
        socket.send(JSON.stringify({ type: "auth", name }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "connectedClients") {
          data.clients.forEach((client) => {
            const content = `<div>${client.name}:${client.origin}<button onclick="sendOffer('${client.id}')">Connect</button><button onclick="sendData('${client.id}')">Send Data</button></div>`;
            const device = document.createElement("div");
            device.id = client.id;
            device.innerHTML = content;
            devicesDiv.appendChild(device);
          });
        }
        if (data.type === "connection") {
          const device = document.createElement("div");
          device.id = data.id;
          device.textContent = `Device: ${data.name} (ID: ${data.id}, Origin: ${data.origin})`;
          devicesDiv.appendChild(device);
        }

        if (data.type === "disconnection") {
          const device = document.getElementById(data.id);
          console.log(`Device disconnected: ID ${data.id}`);
          if (device) {
            devicesDiv.removeChild(device);
          }
        }
        if (data.type === "offer") {
          pc.peerId = data.from
          pc.setRemoteDescription(data.offer);
          pc.createAnswer().then((answer) => {
            pc.setLocalDescription(answer);
            socket.send(
              JSON.stringify({ type: "answer", answer, targetId: data.from }),
            );
          });
        }

        if (data.type === "answer") {
          pc.peerId = data.from
          pc.setRemoteDescription(data.answer);
        }

        if (data.type === 'ice-candidate') {
          pc.addIceCandidate(data.candidate);
        }
      };
    </script>
  </body>
</html>
